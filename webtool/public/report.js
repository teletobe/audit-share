async function loadEFAs() {
  const container = document.getElementById("efa-container");
  container.innerHTML = "<p>Loading EFAs...</p>";

  try {
    // For demo, static list of JSON files; replace with fetch from API or directory read
    const efaFiles = [
      "EFA-ID-01.json",
      "EFA-ID-02.json",
      "EFA-ID-03.json",
      "EFA-ID-04.json",
    ];

    container.innerHTML = "<h2 class='overview-title'>Available EFAs</h2>";
    const grid = document.createElement("div");
    grid.className = "efa-grid"; // make sure to style .efa-grid in CSS

    for (let file of efaFiles) {
      const res = await fetch(`/efas/${file}`);
      const efa = await res.json();

      const card = document.createElement("div");
      card.className = "efa-small-card";
      card.innerHTML = `
          <h3>${efa.title}</h3>
          <p><strong>ID:</strong> ${efa.id}</p>
          <p><strong>Tests:</strong> ${efa.testableCriteria.length}</p>
          <p><strong>Narratives:</strong> ${efa.linkedNarratives.length}</p>
        `;

      card.addEventListener("click", () => renderFullEFA(efa, file));
      grid.appendChild(card);
    }

    container.appendChild(grid);
  } catch (err) {
    container.innerHTML = `<p style="color:red">Error loading EFAs: ${err}</p>`;
  }
}

async function downloadPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  let y = 25; // start a bit lower for breathing room
  const leftMargin = 20;
  const rightMargin = 190; // A4 width is 210mm, keep 20mm margin each side
  const lineHeight = 6;

  try {
    // Load the list of EFA files
    const res = await fetch("/efas/index.json");
    const efaFiles = await res.json();

    // Preload all EFAs
    const efas = [];
    for (let file of efaFiles) {
      const efaRes = await fetch(`/efas/${file}`);
      const efa = await efaRes.json();
      efas.push(efa);
    }

    // ---------- TITLE PAGE ----------
    doc.setFont("helvetica", "bold");
    doc.setFontSize(22);
    doc.text("Ethical Focus Area Report", 105, 70, { align: "center" });

    doc.setFont("helvetica", "normal");
    doc.setFontSize(12);
    const today = new Date().toLocaleDateString();
    doc.text(`Generated on ${today}`, 105, 85, { align: "center" });

    // Summary stats
    const totalEFAs = efas.length;
    const totalCriteria = efas.reduce(
      (sum, e) => sum + e.testableCriteria.length,
      0
    );
    const totalNarratives = efas.reduce(
      (sum, e) => sum + e.linkedNarratives.length,
      0
    );

    doc.setFontSize(11);
    doc.text(`Number of EFAs: ${totalEFAs}`, 105, 110, { align: "center" });
    doc.text(`Total Testable Criteria: ${totalCriteria}`, 105, 120, {
      align: "center",
    });
    doc.text(`Total Narratives: ${totalNarratives}`, 105, 130, {
      align: "center",
    });

    // Footer line
    doc.setDrawColor(180);
    doc.line(leftMargin, 280, rightMargin, 280);
    doc.setFontSize(9);
    doc.text("Generated by EFA Tool", 105, 287, { align: "center" });

    // New page for details
    doc.addPage();
    y = 25;

    // ---------- DETAILED PAGES ----------
    efas.forEach((efa, idx) => {
      // Title
      doc.setFont("helvetica", "bold");
      doc.setFontSize(14);
      doc.text(`${efa.title} (${efa.id})`, leftMargin, y);
      y += lineHeight + 2;

      // Description
      doc.setFont("helvetica", "normal");
      doc.setFontSize(11);
      const descLines = doc.splitTextToSize(
        efa.description,
        rightMargin - leftMargin
      );
      doc.text(descLines, leftMargin, y);
      y += descLines.length * lineHeight + 4;

      // Core Values
      doc.setFont("helvetica", "bold");
      doc.setFontSize(12);
      doc.text("Core Values", leftMargin, y);
      y += lineHeight;
      doc.setFont("helvetica", "normal");
      efa.coreValues.forEach((v) => {
        doc.text(`• ${v}`, leftMargin + 5, y);
        y += lineHeight;
      });
      y += 4;

      // Testable Criteria
      doc.setFont("helvetica", "bold");
      doc.setFontSize(12);
      doc.text("Testable Criteria", leftMargin, y);
      y += lineHeight + 2;

      doc.setFont("helvetica", "normal");
      efa.testableCriteria.forEach((c, i) => {
        doc.setFont("helvetica", "bold");
        doc.text(`${i + 1}. ${c.type}`, leftMargin + 5, y);
        y += lineHeight;

        doc.setFont("helvetica", "normal");
        const details = [
          `Description: ${c.description}`,
          `Method: ${c.method}`,
          `Status: ${c.status}`,
          `Result: ${c.result || "--"}`,
          `Details: ${c.details || ""}`,
        ];
        details.forEach((line) => {
          const wrapped = doc.splitTextToSize(
            line,
            rightMargin - (leftMargin + 10)
          );
          doc.text(wrapped, leftMargin + 10, y);
          y += wrapped.length * lineHeight;
        });
        y += 4;

        if (y > 260) {
          doc.addPage();
          y = 25;
        }
      });

      // Narratives
      doc.setFont("helvetica", "bold");
      doc.setFontSize(12);
      doc.text("Linked Narratives", leftMargin, y);
      y += lineHeight;
      doc.setFont("helvetica", "normal");
      doc.text(
        `${efa.linkedNarratives.length} narratives linked.`,
        leftMargin + 5,
        y
      );
      y += 12;

      // Page break between EFAs
      if (idx < efas.length - 1) {
        doc.addPage();
        y = 25;
      }
    });

    doc.save("efa-full-report.pdf");
  } catch (err) {
    alert("Error generating PDF: " + err);
    console.error(err);
  }
}

function renderFullEFA(efa) {
  const container = document.getElementById("efa-container");

  // Create back button
  const backButton = document.createElement("button");
  backButton.className = "back-button"; // Add this line
  backButton.textContent = "← Back to Overview";
  backButton.addEventListener("click", loadEFAs);

  // Build detailed EFA view
  const content = document.createElement("div");
  content.className = "full-efa";

  // Header section
  content.innerHTML = `
    <h2>${efa.title}</h2>
    <p><strong>ID:</strong> ${efa.id}</p>
    <p><strong>Description:</strong> ${efa.description}</p>
    
    <div class="values-section">
      <h3>Core Values</h3>
      <ul>${efa.coreValues.map((v) => `<li>${v}</li>`).join("")}</ul>
    </div>
    
    <h3>Testable Criteria</h3>
    <div class="criteria-container">
      ${efa.testableCriteria
        .map(
          (criterion, i) => `
        <div class="criterion" data-index="${i}">
          <div class="criterion-header">
            <h4>${i + 1}. ${criterion.type}</h4>
            <div class="status-controls">
              <select class="status-select">
                <option value="Planned" ${
                  criterion.status === "Planned" ? "selected" : ""
                }>Planned</option>
                <option value="Testing" ${
                  criterion.status === "Testing" ? "selected" : ""
                }>Testing</option>
                <option value="Tested" ${
                  criterion.status === "Tested" ? "selected" : ""
                }>Tested</option>
              </select>
              
              <div class="result-controls" style="display:${
                criterion.status === "Tested" ? "block" : "none"
              }">
                <select class="result-select">
                  <option value="Success" ${
                    criterion.result === "Success" ? "selected" : ""
                  }>Success</option>
                  <option value="Failed" ${
                    criterion.result === "Failed" ? "selected" : ""
                  }>Failed</option>
                </select>
              </div>
            </div>
          </div>
          
          <p><strong>Description:</strong> ${criterion.description}</p>
          <p><strong>Method:</strong> ${criterion.method}</p>
          
          <div class="comment-section" style="display:${
            criterion.status === "Tested" ? "block" : "none"
          }">
            <label><strong>Comments:</strong></label>
            <textarea class="comment-text">${
              criterion.comments || ""
            }</textarea>
          </div>
        </div>
      `
        )
        .join("")}
    </div>
    <div class="narratives-section">
      <h3>Linked Narratives (${efa.linkedNarratives.length})</h3>
      <ul>${efa.linkedNarratives.map((n) => `<li>${n}</li>`).join("")}</ul>
    </div>

    <div class="save-container">
      <button id="save-efa">Save Changes</button>
    </div>
  `;

  // Add event listeners for status changes
  const statusSelects = content.querySelectorAll(".status-select");
  statusSelects.forEach((select) => {
    select.addEventListener("change", function () {
      const criterionDiv = this.closest(".criterion");
      const resultControls = criterionDiv.querySelector(".result-controls");
      const commentSection = criterionDiv.querySelector(".comment-section");

      if (this.value === "Tested") {
        resultControls.style.display = "block";
        commentSection.style.display = "block";
      } else {
        resultControls.style.display = "none";
        commentSection.style.display = "none";
      }
    });
  });

  // Add save button functionality
  const saveButton = content.querySelector("#save-efa");
  saveButton.addEventListener("click", () => {
    const criteria = Array.from(content.querySelectorAll(".criterion")).map(
      (criterionDiv) => {
        const index = parseInt(criterionDiv.dataset.index);
        const status = criterionDiv.querySelector(".status-select").value;
        const result =
          status === "Tested"
            ? criterionDiv.querySelector(".result-select").value
            : null;
        const comments =
          status === "Tested"
            ? criterionDiv.querySelector(".comment-text").value
            : null;

        return {
          ...efa.testableCriteria[index],
          status,
          result,
          comments,
        };
      }
    );

    // Create updated EFA object
    const updatedEFA = {
      ...efa,
      testableCriteria: criteria,
    };

    // Save logic would go here (API call or local storage)
    console.log("Updated EFA:", updatedEFA);
    alert("Changes saved successfully!");

    // Re-render with updated data
    renderFullEFA(updatedEFA);
  });

  // Clear container and add new content
  container.innerHTML = "";
  container.appendChild(backButton);
  container.appendChild(content);
}
document.getElementById("download-pdf").addEventListener("click", downloadPDF);

// load overview on startup
loadEFAs();
