<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>EFA Creator - Cluster View</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --primary: #0077cc;
        --primary-dark: #0050a6;
        --secondary: #7209b7;
        --light: #f8f9fa;
        --dark: #212529;
        --gray: #6c757d;
        --light-gray: #e9ecef;
        --success: #2ecc71;
        --danger: #e74c3c;
        --warning: #f39c12;
        --border: #dee2e6;
        --bg-card: #ffffff;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Inter", sans-serif;
      }

      body {
        background-color: var(--bg-card);
        color: var(--dark);
        line-height: 1.6;
        min-width: 1400px;
        overflow-x: auto;
      }

      .container {
        max-width: 1600px;
        margin: 0 auto;
        padding: 20px;
        display: flex;
        gap: 20px;
      }

      header {
        text-align: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 1px solid var(--border);
        width: 100%;
      }

      header h1 {
        color: var(--primary);
        margin-bottom: 10px;
      }

      .upload-section {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
        align-items: center;
      }

      #json-upload {
        padding: 10px;
        border: 1px solid var(--border);
        border-radius: 6px;
        background: white;
        flex-grow: 1;
      }

      .btn {
        padding: 10px 20px;
        background: var(--primary);
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.3s ease;
      }

      .btn:hover {
        background: var(--primary-dark);
      }

      .btn.primary {
        background: var(--secondary);
      }

      .btn.primary:hover {
        background: #5f0a9d;
      }

      .narratives-table {
        background: white;
        padding: 25px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        overflow: auto;
        max-width: none;
        flex: 1;
      }

      .sidebar {
        width: 300px;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
      }

      .sidebar h2 {
        font-size: 1.2rem;
        color: var(--primary);
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid var(--border);
      }

      .narrative-item {
        padding: 10px;
        margin-bottom: 8px;
        background: var(--light);
        border: 1px solid var(--border);
        border-radius: 4px;
        cursor: grab;
        transition: all 0.2s ease;
      }

      .narrative-item:hover {
        background: var(--light-gray);
        transform: translateY(-2px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .narrative-item:active {
        cursor: grabbing;
      }

      .cluster-list {
        margin-top: 20px;
      }

      .cluster-item {
        padding: 10px;
        margin-bottom: 8px;
        background: #f0f8ff;
        border: 1px solid #d0e0ff;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .cluster-item:hover {
        background: #e0f0ff;
      }

      .cluster-item.active {
        background: #c0e0ff;
        border-color: var(--primary);
        font-weight: 600;
      }

      .cluster-item .delete-cluster {
        float: right;
        color: var(--danger);
        cursor: pointer;
        font-weight: bold;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin: 20px 0;
      }

      th,
      td {
        padding: 15px 20px;
        text-align: left;
        border-bottom: 1px solid var(--border);
      }

      th {
        background-color: rgba(67, 97, 238, 0.1);
        color: var(--primary);
        font-weight: 600;
      }

      tbody tr:hover {
        background-color: rgba(67, 97, 238, 0.05);
      }

      .back-button {
        display: block;
        margin: 40px auto 20px auto;
        padding: 12px 20px;
        background-color: var(--gray);
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 16px;
        text-align: center;
        max-width: 200px;
        transition: background-color 0.3s ease;
      }

      .back-button:hover {
        background-color: #5a6268;
      }

      .table-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 20px;
      }

      .view-toggle {
        display: flex;
        gap: 10px;
      }

      #free-plane-container {
        position: relative;
        width: 100%;
        height: 80vh;
        min-height: 700px;
        min-width: 1200px;
        border: 1px solid var(--border);
        border-radius: 6px;
        margin-top: 20px;
        overflow: hidden;
        background-color: var(--light);
        display: none;
      }

      .plane-entry {
        position: absolute;
        padding: 12px;
        background-color: rgba(255, 255, 255, 0.9);
        border: 1px solid var(--border);
        border-radius: 6px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        cursor: move;
        user-select: none;
        min-width: 300px;
        max-width: 350px;
        z-index: 10;
        transition: box-shadow 0.2s ease;
      }

      .plane-entry:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        z-index: 100;
      }

      .plane-entry-header {
        display: flex;
        align-items: center;
        margin-bottom: 8px;
      }

      .plane-entry-header input[type="checkbox"] {
        margin-right: 8px;
      }

      .plane-entry-name {
        font-weight: 600;
        font-size: 15px;
        color: var(--dark);
        flex-grow: 1;
      }

      .plane-entry-content {
        font-size: 14px;
        color: var(--dark);
        margin-bottom: 8px;
        line-height: 1.4;
      }

      .plane-entry-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
        margin-top: 6px;
      }

      .plane-tag {
        padding: 4px 8px;
        background-color: var(--light-gray);
        border-radius: 50px;
        font-size: 12px;
        color: var(--dark);
      }

      .cluster-highlight {
        background-color: rgba(173, 216, 230, 0.3);
        border: 2px dashed #1e90ff;
      }

      .plane-entry .delete-entry {
        position: absolute;
        top: 5px;
        right: 5px;
        color: var(--danger);
        cursor: pointer;
        font-size: 18px;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.7);
      }

      .plane-entry .delete-entry:hover {
        background: rgba(231, 76, 60, 0.1);
      }

      .cluster-tag {
        position: absolute;
        top: -10px;
        right: 10px;
        padding: 3px 8px;
        background: var(--secondary);
        color: white;
        font-size: 10px;
        border-radius: 10px;
        font-weight: bold;
        z-index: 20;
      }

      #plane-lines {
        pointer-events: none;
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 1;
      }

      #add-cluster-btn {
        margin-top: 10px;
        background: var(--primary);
        color: white;
        border: none;
        border-radius: 4px;
        padding: 8px 12px;
        cursor: pointer;
        transition: background 0.3s ease;
      }

      #add-cluster-btn:hover {
        background: var(--primary-dark);
      }

      /* Modal styles */
      #modal-overlay {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 40;
      }

      #efa-modal {
        display: none;
        position: fixed;
        top: 10%;
        left: 50%;
        transform: translateX(-50%);
        background: white;
        padding: 2rem;
        border-radius: 0.5rem;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        z-index: 50;
        max-width: 1400px;
        width: 95%;
        overflow-y: auto;
        max-height: 90vh;
      }

      #modal-close-btn {
        position: absolute;
        top: 1.5rem;
        right: 1.5rem;
        font-size: 2rem;
        border: none;
        background: none;
        cursor: pointer;
      }

      #selected-narratives {
        margin-bottom: 1rem;
        max-height: 800px;
        overflow-y: auto;
        border: 1px solid #ccc;
        padding: 0.5rem;
        font-size: 0.9rem;
        background-color: #f9f9f9;
      }

      .core-values-section {
        margin-top: 1rem;
        padding: 1rem;
        background-color: #f8f9fa;
        border-radius: 0.5rem;
      }

      .checkbox-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 0.1rem 1rem;
        margin-left: 20px;
      }

      .criteria-entry {
        margin-bottom: 15px;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 6px;
        background-color: #f9f9f9;
      }

      .narrative-full {
        margin-bottom: 1.5rem;
      }

      .narrative-full h3 {
        margin-top: 0;
        margin-bottom: 0.5rem;
        font-size: 1.1rem;
        color: #333;
        font-weight: 600;
      }

      .narrative-content {
        white-space: pre-wrap;
        word-break: break-word;
        background-color: #f5f5f5;
        padding: 1rem;
        border-radius: 6px;
        max-height: 200px;
        overflow-y: auto;
        font-family: inherit;
        margin: 0;
        line-height: 1.5;
        font-size: 0.95rem;
        border: 1px solid #e0e0e0;
      }

      #efa-form {
        display: grid;
        gap: 1rem;
      }

      #efa-form input,
      #efa-form textarea,
      #efa-form select {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid #ddd;
        border-radius: 0.375rem;
        font-size: 1rem;
      }

      #efa-form button[type="submit"] {
        background-color: #2563eb;
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: 0.375rem;
        border: none;
        cursor: pointer;
        font-weight: 600;
        font-size: 1rem;
        transition: background-color 0.2s ease;
      }

      #efa-form button[type="submit"]:hover {
        background-color: #1d4ed8;
      }

      #narrative-table {
        display: none;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <button class="back-button" onclick="location.href='efa.html'">
        ← Back
      </button>
    </div>
    <div class="container">
      <div class="sidebar">
        <h2>Available Narratives</h2>
        <div id="narrative-list"></div>
        <div class="cluster-list">
          <h2>Clusters</h2>
          <div id="clusters-container"></div>
          <button id="add-cluster-btn">+ Add Cluster</button>
        </div>
      </div>

      <div class="narratives-table">
        <header>
          <h1>EFA Creator - Cluster View</h1>
          <p>
            Upload a JSON file with tagged narratives. Drag narratives from the
            sidebar into clusters in the main area.
          </p>
        </header>

        <div class="upload-section">
          <input type="file" id="json-upload" accept=".json" />
          <button id="load-json-btn" class="btn">Load JSON</button>
        </div>

        <table id="narrative-table">
          <thead>
            <tr>
              <th>Select</th>
              <th>Name</th>
              <th>Context</th>
              <th>Tags</th>
            </tr>
          </thead>
          <tbody id="table-body"></tbody>
        </table>

        <div id="free-plane-container">
          <svg
            id="plane-lines"
            style="
              position: absolute;
              top: 0;
              left: 0;
              width: 100%;
              height: 100%;
              pointer-events: none;
            "
          ></svg>
        </div>

        <div
          class="table-footer"
          id="efa-btn-container"
          style="display: none; margin-top: 20px"
        >
          <div class="view-toggle">
            <button id="toggle-view" class="btn">
              Switch to Free Plane View
            </button>
            <button id="reset-view" class="btn" style="display: none">
              Reset Plane Positions
            </button>
            <button id="toggle-lines-btn" class="btn">Hide Lines</button>
          </div>
          <button id="create-efa-btn" class="btn primary">
            Create EFA from Selection
          </button>
        </div>
      </div>
    </div>

    <!-- Modal Overlay -->
    <div id="modal-overlay"></div>

    <!-- EFA Modal -->
    <div id="efa-modal">
      <button id="modal-close-btn">✕</button>
      <h2>Create EFA</h2>

      <div id="selected-narratives"></div>

      <form id="efa-form">
        <input
          type="text"
          name="efa-id"
          placeholder="EFA ID"
          class="w-full border p-2 rounded"
          style="margin-bottom: 0.5rem"
          required
        />
        <input
          type="text"
          name="efa-title"
          placeholder="EFA Title"
          class="w-full border p-2 rounded"
          style="margin-bottom: 0.5rem"
          required
        />
        <textarea
          name="efa-description"
          placeholder="Description"
          class="w-full border p-2 rounded"
          required
        ></textarea>

        <div class="core-values-section" style="margin-top: 1rem">
          <label
            ><strong>Core Ethical Values</strong> (select one or more):</label
          >
          <div id="coreValuesContainer" class="checkbox-grid"></div>
        </div>

        <hr />

        <div id="criteria-section">
          <h3>Testable Criteria</h3>
          <div id="criteria-list"></div>
          <button
            type="button"
            id="add-criteria-btn"
            style="
              margin-top: 0.5rem;
              margin-bottom: 0.5rem;
              padding: 0.4rem 1rem;
              background-color: #eee;
              border-radius: 4px;
              cursor: pointer;
              border: 1px solid #ccc;
            "
          >
            + Add Criterion
          </button>
        </div>

        <input
          type="text"
          name="efa-weight"
          placeholder="Weight"
          class="w-full border p-2 rounded"
          style="margin-bottom: 0.5rem"
        />
        <input
          type="text"
          name="efa-priority"
          placeholder="Priority"
          class="w-full border p-2 rounded"
          style="margin-bottom: 0.5rem"
        />

        <button
          type="submit"
          class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
        >
          Save EFA
        </button>
      </form>
    </div>

    <script>
      let jsonData = [];
      let clusters = [{ id: 1, name: "Cluster 1", narratives: [] }];
      let currentClusterId = 1;
      let selectedItems = [];
      let currentView = "table";
      let linesVisible = true;
      let nextClusterId = 2;

      document.addEventListener("DOMContentLoaded", () => {
        const fileInput = document.getElementById("json-upload");
        const loadBtn = document.getElementById("load-json-btn");
        const efaBtn = document.getElementById("create-efa-btn");
        const efaBtnContainer = document.getElementById("efa-btn-container");
        const modalForm = document.getElementById("efa-form");
        const selectedNarrativesContainer = document.getElementById(
          "selected-narratives"
        );
        const addCriteriaBtn = document.getElementById("add-criteria-btn");
        const criteriaList = document.getElementById("criteria-list");
        const toggleViewBtn = document.getElementById("toggle-view");
        const resetViewBtn = document.getElementById("reset-view");
        const planeContainer = document.getElementById("free-plane-container");
        const narrativeList = document.getElementById("narrative-list");
        const clustersContainer = document.getElementById("clusters-container");
        const addClusterBtn = document.getElementById("add-cluster-btn");
        const tableBody = document.getElementById("table-body");
        const narrativeTable = document.getElementById("narrative-table");
        const modalCloseBtn = document.getElementById("modal-close-btn");
        const modalOverlay = document.getElementById("modal-overlay");
        const toggleLinesBtn = document.getElementById("toggle-lines-btn");

        // Initialize core values
        const valueOptions = [
          "Privacy",
          "Transparency",
          "Accountability",
          "Autonomy",
          "Safety",
          "Trust",
          "Dignity",
          "Reliability",
          "Accessibility",
          "Fairness",
          "Inclusiveness",
          "Authenticity",
          "Beneficence",
          "Creativity",
          "Diversity",
          "Growth",
          "Empowerment",
          "Happiness",
          "Health",
          "Honesty",
          "Justice",
          "Participation",
          "Respect",
          "Support / Solidarity",
          "Sustainability",
          "Non-maleficence",
        ];

        const coreValuesContainer = document.getElementById(
          "coreValuesContainer"
        );
        coreValuesContainer.classList.add("checkbox-grid");

        valueOptions.forEach((value) => {
          const label = document.createElement("label");
          const checkbox = document.createElement("input");
          checkbox.type = "checkbox";
          checkbox.name = "efa-core-values";
          checkbox.value = value;
          label.appendChild(checkbox);
          label.appendChild(document.createTextNode(value));
          coreValuesContainer.appendChild(label);
        });

        // Modal close buttons
        modalCloseBtn.addEventListener("click", closeModal);
        modalOverlay.addEventListener("click", closeModal);

        function closeModal() {
          document.getElementById("efa-modal").style.display = "none";
          document.getElementById("modal-overlay").style.display = "none";
        }

        // Add criteria button
        addCriteriaBtn.addEventListener("click", () => {
          const container = document.createElement("div");
          container.classList.add("criteria-entry");

          container.innerHTML = `
<label>Requirement Type:
<select name="requirement-type">
<option value="must">Must do</option>
<option value="should">Should do</option>
<option value="must-not">Must not do</option>
</select>
</label>
<label>Description:<input type="text" name="criteria-description" required></label>
<label>How to test:<input type="text" name="criteria-method" required></label>
<label>Status:
<select name="criteria-status">
<option value="not-tested">Not tested</option>
<option value="passed">Passed</option>
<option value="failed">Failed</option>
</select>
</label>
<hr>
`;

          criteriaList.appendChild(container);
        });

        // Form submission
        modalForm.addEventListener("submit", function (e) {
          e.preventDefault();

          const coreValues = Array.from(
            modalForm.querySelectorAll("input[name='efa-core-values']:checked")
          ).map((el) => el.value);

          const criteriaEntries = Array.from(
            criteriaList.querySelectorAll(".criteria-entry")
          );
          const testableCriteria = criteriaEntries.map((entry) => {
            return {
              type: entry.querySelector("select[name='requirement-type']")
                .value,
              description: entry.querySelector(
                "input[name='criteria-description']"
              ).value,
              method: entry.querySelector("input[name='criteria-method']")
                .value,
              status: entry.querySelector("select[name='criteria-status']")
                .value,
            };
          });

          const efa = {
            id: modalForm["efa-id"].value,
            title: modalForm["efa-title"].value,
            description: modalForm["efa-description"].value,
            coreValues,
            testableCriteria,
            weight: modalForm["efa-weight"].value,
            priority: modalForm["efa-priority"].value,
            linkedNarratives: JSON.parse(modalForm.dataset.selectedIndexes).map(
              (i) => jsonData[i]
            ),
          };

          console.log("Created EFA:", efa);
          alert(
            `EFA created successfully (check console for JSON).\n${JSON.stringify(
              efa,
              null,
              2
            )}`
          );

          const blob = new Blob([JSON.stringify(efa, null, 2)], {
            type: "application/json",
          });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `${efa.id || "efa"}.json`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);

          modalForm.reset();
          criteriaList.innerHTML = "";
          selectedNarrativesContainer.innerHTML = "";
          const checkedValues = coreValuesContainer.querySelectorAll(
            "input[name='efa-core-values']"
          );
          checkedValues.forEach((cb) => (cb.checked = false));
          closeModal();
        });

        // Load JSON button
        loadBtn.addEventListener("click", () => {
          const file = fileInput.files[0];
          if (!file) {
            alert("Please select a file.");
            return;
          }

          const reader = new FileReader();
          reader.onload = function (e) {
            try {
              jsonData = JSON.parse(e.target.result);
              if (!Array.isArray(jsonData)) {
                throw new Error("JSON must be an array.");
              }

              // Populate sidebar
              renderNarrativeList();
              renderClusters();
              renderTable();

              efaBtnContainer.style.display = "flex";
              narrativeTable.style.display = "table";
            } catch (err) {
              alert("Error parsing JSON: " + err.message);
            }
          };

          reader.readAsText(file);
        });

        // Render table
        function renderTable() {
          tableBody.innerHTML = "";
          jsonData.forEach((narrative, index) => {
            const row = document.createElement("tr");

            const selectCell = document.createElement("td");
            selectCell.classList.add("select-cell");

            const checkbox = document.createElement("input");
            checkbox.type = "checkbox";
            checkbox.classList.add("select-narrative");
            checkbox.dataset.index = index;
            checkbox.addEventListener("change", () =>
              toggleItemSelection(index)
            );

            selectCell.appendChild(checkbox);
            row.appendChild(selectCell);

            const nameCell = document.createElement("td");
            nameCell.textContent = narrative.name || "—";
            row.appendChild(nameCell);

            const contextCell = document.createElement("td");
            contextCell.textContent = narrative.context || "—";
            row.appendChild(contextCell);

            const tagsCell = document.createElement("td");
            if (Array.isArray(narrative.tags)) {
              tagsCell.textContent = narrative.tags
                .map((tag) => {
                  let type;
                  if (tag.weight === 3) type = "SI";
                  else if (tag.weight === 2) type = "I";
                  else if (tag.weight === 1) type = "R";
                  else type = "?";
                  return `${tag.name} (${type})`;
                })
                .join(", ");
            } else {
              tagsCell.textContent = "—";
            }
            row.appendChild(tagsCell);

            tableBody.appendChild(row);
          });
        }

        // Add cluster button
        addClusterBtn.addEventListener("click", () => {
          const newCluster = {
            id: nextClusterId++,
            name: `Cluster ${nextClusterId - 1}`,
            narratives: [],
          };
          clusters.push(newCluster);
          renderClusters();
          selectCluster(newCluster.id);
        });

        // Toggle view button
        toggleViewBtn.addEventListener("click", () => {
          if (currentView === "table") {
            currentView = "plane";
            narrativeTable.style.display = "none";
            planeContainer.style.display = "block";
            toggleViewBtn.textContent = "Switch to Table View";
            resetViewBtn.style.display = "inline-block";
            renderPlaneView();
          } else {
            currentView = "table";
            narrativeTable.style.display = "table";
            planeContainer.style.display = "none";
            toggleViewBtn.textContent = "Switch to Free Plane View";
            resetViewBtn.style.display = "none";
          }
        });

        // Reset view button
        resetViewBtn.addEventListener("click", renderPlaneView);

        // Create EFA button
        efaBtn.addEventListener("click", async () => {
          const checkboxes = document.querySelectorAll(
            ".select-narrative:checked"
          );
          const selectedIndexes = Array.from(checkboxes).map((cb) =>
            parseInt(cb.dataset.index)
          );
          const selectedNarratives = selectedIndexes.map(
            (index) => jsonData[index]
          );

          if (selectedNarratives.length === 0) {
            alert("Please select at least one narrative.");
            return;
          }

          document.getElementById("efa-modal").style.display = "block";
          document.getElementById("modal-overlay").style.display = "block";
          modalForm.dataset.selectedIndexes = JSON.stringify(selectedIndexes);

          selectedNarrativesContainer.innerHTML =
            '<div class="loading">Loading narrative content...</div>';

          try {
            const narrativeContents = await Promise.all(
              selectedNarratives.map(async (narrative) => {
                try {
                  const response = await fetch(
                    `narratives/${narrative.name}.txt`
                  );
                  if (!response.ok) {
                    throw new Error(`File not found: ${narrative.name}.txt`);
                  }
                  return await response.text();
                } catch (error) {
                  console.error(error);
                  return `Error loading narrative content: ${
                    error.message
                  }\n\nJSON Context: ${narrative.context || "No context"}`;
                }
              })
            );

            selectedNarrativesContainer.innerHTML = selectedNarratives
              .map((n, i) => {
                return `
<div class="narrative-full">
<h3>${n.name || "Untitled"}</h3>
<div class="narrative-content">${narrativeContents[i]}</div>
</div>
`;
              })
              .join("<hr>");
          } catch (error) {
            console.error("Error loading narratives:", error);
            selectedNarrativesContainer.innerHTML = `<div class="error">Error loading narrative content: ${error.message}</div>`;
          }
        });

        // Render narrative list in sidebar
        function renderNarrativeList() {
          narrativeList.innerHTML = "";
          jsonData.forEach((narrative, index) => {
            const item = document.createElement("div");
            item.className = "narrative-item";
            item.textContent = narrative.name || "Untitled";
            item.dataset.index = index;
            item.draggable = true;

            item.addEventListener("dragstart", (e) => {
              e.dataTransfer.setData("text/plain", index.toString());
            });

            narrativeList.appendChild(item);
          });
        }

        // Render clusters in sidebar
        function renderClusters() {
          clustersContainer.innerHTML = "";
          clusters.forEach((cluster) => {
            const item = document.createElement("div");
            item.className = "cluster-item";
            if (cluster.id === currentClusterId) {
              item.classList.add("active");
            }
            item.textContent = cluster.name;
            item.dataset.id = cluster.id;

            const deleteBtn = document.createElement("span");
            deleteBtn.className = "delete-cluster";
            deleteBtn.textContent = "✕";
            deleteBtn.addEventListener("click", (e) => {
              e.stopPropagation();
              deleteCluster(cluster.id);
            });

            item.appendChild(deleteBtn);

            item.addEventListener("click", () => {
              selectCluster(cluster.id);
            });

            clustersContainer.appendChild(item);
          });
        }

        // Select a cluster
        function selectCluster(clusterId) {
          currentClusterId = clusterId;

          // Update active state
          document.querySelectorAll(".cluster-item").forEach((item) => {
            if (parseInt(item.dataset.id) === clusterId) {
              item.classList.add("active");
            } else {
              item.classList.remove("active");
            }
          });

          if (currentView === "plane") {
            renderPlaneView();
          }
        }

        // Delete a cluster
        function deleteCluster(clusterId) {
          if (clusters.length <= 1) {
            alert("You need at least one cluster");
            return;
          }

          clusters = clusters.filter((cluster) => cluster.id !== clusterId);
          if (currentClusterId === clusterId) {
            currentClusterId = clusters[0].id;
          }
          renderClusters();
          if (currentView === "plane") {
            renderPlaneView();
          }
        }

        // Render the plane view
        function renderPlaneView() {
          planeContainer.innerHTML = "";

          let svg = document.createElementNS(
            "http://www.w3.org/2000/svg",
            "svg"
          );
          svg.id = "plane-lines";
          svg.style.position = "absolute";
          svg.style.top = "0";
          svg.style.left = "0";
          svg.style.width = "100%";
          svg.style.height = "100%";
          svg.style.pointerEvents = "none";
          planeContainer.appendChild(svg);

          // Set initial line visibility
          svg.style.display = linesVisible ? "block" : "none";

          // Find the current cluster
          const currentCluster = clusters.find(
            (c) => c.id === currentClusterId
          );
          if (!currentCluster) return;

          // Render narratives in the current cluster
          currentCluster.narratives.forEach((narrative, index) => {
            const entry = createPlaneEntry(narrative, index);
            planeContainer.appendChild(entry);
          });

          drawTagLines();

          // Make plane container a drop target
          planeContainer.addEventListener("dragover", (e) => {
            e.preventDefault();
          });

          planeContainer.addEventListener("drop", (e) => {
            e.preventDefault();
            const index = parseInt(e.dataTransfer.getData("text/plain"));
            const narrative = jsonData[index];

            if (!narrative) return;

            // Find the current cluster
            const cluster = clusters.find((c) => c.id === currentClusterId);
            if (!cluster) return;

            // Check if narrative is already in this cluster
            if (cluster.narratives.some((n) => n.index === index)) return;

            // Add to cluster
            cluster.narratives.push({
              ...narrative,
              index: index,
              x: e.offsetX,
              y: e.offsetY,
            });

            renderPlaneView();
          });
        }

        // Create a plane entry
        function createPlaneEntry(narrative, positionIndex) {
          const entry = document.createElement("div");
          entry.className = "plane-entry";
          entry.style.left = `${narrative.x || 100 + positionIndex * 20}px`;
          entry.style.top = `${narrative.y || 100 + positionIndex * 20}px`;

          entry.innerHTML = `
<span class="cluster-tag">Cluster ${
            clusters.findIndex((c) => c.id === currentClusterId) + 1
          }</span>
<div class="delete-entry">✕</div>
<div class="plane-entry-header">
<input type="checkbox" class="select-narrative" data-index="${narrative.index}">
<div class="plane-entry-name">${narrative.name || "Untitled"}</div>
</div>
<div class="plane-entry-content">${
            narrative.context || "No context provided"
          }</div>
<div class="plane-entry-tags">
${
  Array.isArray(narrative.tags)
    ? narrative.tags
        .map((tag) => {
          let type =
            tag.weight === 3
              ? "SI"
              : tag.weight === 2
              ? "I"
              : tag.weight === 1
              ? "R"
              : "?";
          return `<span class="plane-tag">${tag.name} (${type})</span>`;
        })
        .join("")
    : ""
}
</div>
`;

          // Add event listener to delete button
          entry
            .querySelector(".delete-entry")
            .addEventListener("click", (e) => {
              e.stopPropagation();
              const cluster = clusters.find((c) => c.id === currentClusterId);
              if (cluster) {
                cluster.narratives = cluster.narratives.filter(
                  (n) => n.index !== narrative.index
                );
                renderPlaneView();
              }
            });

          // Make draggable
          makeDraggable(entry, narrative);

          // Add checkbox event listener
          const checkbox = entry.querySelector("input[type='checkbox']");
          checkbox.addEventListener("change", () =>
            toggleItemSelection(narrative.index)
          );

          return entry;
        }

        // Make an entry draggable
        function makeDraggable(element, narrative) {
          let pos1 = 0,
            pos2 = 0,
            pos3 = 0,
            pos4 = 0;
          element.onmousedown = dragMouseDown;

          function dragMouseDown(e) {
            e = e || window.event;
            e.preventDefault();
            pos3 = e.clientX;
            pos4 = e.clientY;
            document.onmouseup = closeDragElement;
            document.onmousemove = elementDrag;
          }

          function elementDrag(e) {
            e = e || window.event;
            e.preventDefault();
            pos1 = pos3 - e.clientX;
            pos2 = pos4 - e.clientY;
            pos3 = e.clientX;
            pos4 = e.clientY;

            const newTop = element.offsetTop - pos2;
            const newLeft = element.offsetLeft - pos1;

            // Update position
            element.style.top = newTop + "px";
            element.style.left = newLeft + "px";

            // Update narrative position in cluster
            const cluster = clusters.find((c) => c.id === currentClusterId);
            if (cluster) {
              const nIndex = cluster.narratives.findIndex(
                (n) => n.index === narrative.index
              );
              if (nIndex !== -1) {
                cluster.narratives[nIndex].x = newLeft;
                cluster.narratives[nIndex].y = newTop;
              }
            }

            drawTagLines();
          }

          function closeDragElement() {
            document.onmouseup = null;
            document.onmousemove = null;
          }
        }

        // Draw tag lines between narratives in the same cluster
        function drawTagLines() {
          const svg = document.getElementById("plane-lines");
          if (!svg) return;
          svg.innerHTML = "";

          const cluster = clusters.find((c) => c.id === currentClusterId);
          if (!cluster) return;

          const entries = Array.from(
            planeContainer.querySelectorAll(".plane-entry")
          );

          // Create a map of tag positions
          const tagMap = {};

          entries.forEach((entry) => {
            const index = parseInt(
              entry.querySelector('input[type="checkbox"]').dataset.index
            );
            const narrative = jsonData[index];
            if (!narrative || !Array.isArray(narrative.tags)) return;

            narrative.tags.forEach((tag) => {
              if (tag.weight < 2) return; // skip less important tags

              const tagEl = Array.from(
                entry.querySelectorAll(".plane-tag")
              ).find((el) => el.textContent.startsWith(tag.name));
              if (!tagEl) return;

              const rect = tagEl.getBoundingClientRect();
              const containerRect = planeContainer.getBoundingClientRect();
              const x = rect.left - containerRect.left + rect.width / 2;
              const y = rect.top - containerRect.top + rect.height / 2;

              if (!tagMap[tag.name]) tagMap[tag.name] = [];
              tagMap[tag.name].push({ x, y, weight: tag.weight });
            });
          });

          // Draw lines for each tag
          Object.entries(tagMap).forEach(([tagName, points]) => {
            if (points.length < 2) return; // Need at least two points to draw a line

            // Draw connections between all points
            for (let i = 0; i < points.length; i++) {
              for (let j = i + 1; j < points.length; j++) {
                const p1 = points[i];
                const p2 = points[j];

                const line = document.createElementNS(
                  "http://www.w3.org/2000/svg",
                  "line"
                );
                line.setAttribute("x1", p1.x);
                line.setAttribute("y1", p1.y);
                line.setAttribute("x2", p2.x);
                line.setAttribute("y2", p2.y);

                let strokeWidth = 2;
                let strokeColor = "rgba(0, 0, 0, 0.2)";

                if (p1.weight === 3 && p2.weight === 3) {
                  strokeWidth = 10;
                  strokeColor = "rgba(255, 0, 0, 0.5)";
                } else if (p1.weight === 3 || p2.weight === 3) {
                  strokeWidth = 6;
                  strokeColor = "rgba(255, 165, 0, 0.5)";
                }

                line.setAttribute("stroke", strokeColor);
                line.setAttribute("stroke-width", strokeWidth);

                svg.appendChild(line);
              }
            }
          });
        }

        // Toggle line visibility
        toggleLinesBtn.addEventListener("click", function () {
          linesVisible = !linesVisible;
          const svg = document.getElementById("plane-lines");
          if (svg) {
            svg.style.display = linesVisible ? "block" : "none";
          }
          this.textContent = linesVisible ? "Hide Lines" : "Show Lines";
        });

        // Toggle item selection
        function toggleItemSelection(index) {
          const itemIndex = selectedItems.indexOf(index);
          if (itemIndex === -1) {
            selectedItems.push(index);
          } else {
            selectedItems.splice(itemIndex, 1);
          }
        }
      });
    </script>
  </body>
</html>
